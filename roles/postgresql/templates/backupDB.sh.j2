# roles/postgresql-install/templates/backupDB.sh.j2
#!/bin/bash
# PostgreSQL Backup Script
# Based on RZD requirements

SCRIPT_FILE="{{ postgresql_backup_script_path }}"
dataDIR="{{ postgresql_data_dir }}"
backupDIR="{{ postgresql_backup_dir }}"
log_name="{{ postgresql_log_dir }}/postgresql-`date +%Y-%m-%d`.log"

# Backup retention (days)
RETENTION_DAYS={{ postgresql_backup_retention }}

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $log_name
}

check_disk_space() {
    available_space=$(df $backupDIR | awk 'NR==2 {print $4}')
    required_space=$(du -s $dataDIR | awk '{print $1}')
    
    if [ $available_space -lt $((required_space * 2)) ]; then
        log "ERROR: Not enough disk space for backup"
        exit 1
    fi
}

perform_backup() {
    log "Starting PostgreSQL backup"
    
    # Create backup directory with timestamp
    backup_path="$backupDIR/pgbackup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p $backup_path
    
    # Perform base backup
    {{ postgresql_bin_dir }}/pg_basebackup -h localhost -U postgres -D $backup_path -X s -P
    
    if [ $? -eq 0 ]; then
        log "Backup completed successfully: $backup_path"
        
        # Cleanup old backups
        find $backupDIR/archive -name "pgbackup_*" -mtime +$RETENTION_DAYS -exec rm -rf {} \;
        
        # Move completed backup to archive
        mv $backup_path $backupDIR/archive/
    else
        log "ERROR: Backup failed"
        exit 1
    fi
}

main() {
    log "Backup script started"
    check_disk_space
    perform_backup
    log "Backup script completed"
}

main "$@"
---
- name: BASE | Create application group
  group:
    name: "{{ app_group }}"
    state: present
  tags: [base]

- name: BASE | Create application user
  user:
    name: "{{ app_user }}"
    group: "{{ app_group }}"
    home: "{{ app_home }}"
    shell: "/bin/bash"
    create_home: yes
    state: present
  tags: [base]

- name: BASE | Create application directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ app_home }}/app", mode: "0755" }
    - { path: "{{ app_home }}/logs", mode: "0755" }
    - { path: "{{ app_home }}/data", mode: "0750" }
    - { path: "{{ app_home }}/backups", mode: "0750" }
    - { path: "{{ app_home }}/config", mode: "0750" }
  tags: [base]

- name: BASE | Set timezone
  timezone:
    name: "{{ timezone }}"
  tags: [base]

- name: BASE | Configure firewall - allow essential ports
  ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto | default('tcp') }}"
  loop:
    - { rule: "allow", port: "22", proto: "tcp", comment: "SSH" }
    - { rule: "allow", port: "80", proto: "tcp", comment: "HTTP" }
    - { rule: "allow", port: "443", proto: "tcp", comment: "HTTPS" }
    - { rule: "allow", port: "8000", proto: "tcp", comment: "App Port" }
  when: firewall_enabled and ansible_os_family == "Debian"
  tags: [base, network, firewall]

- name: BASE | Enable firewall with default deny
  ufw:
    state: enabled
    policy: deny
    direction: incoming
  when: firewall_enabled and ansible_os_family == "Debian"
  tags: [base, network, firewall]

- name: BASE | Configure network kernel parameters for web server
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: "net.core.somaxconn", value: "65535" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "65535" }
    - { name: "net.ipv4.ip_local_port_range", value: "1024 65535" }
    - { name: "net.ipv4.tcp_tw_reuse", value: "1" }
  tags: [base, network, performance]

- name: BASE | Verify firewall status
  command: ufw status verbose
  register: ufw_status
  changed_when: false
  when: firewall_enabled and ansible_os_family == "Debian"
  tags: [base, network, firewall]